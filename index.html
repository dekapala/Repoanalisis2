<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel de An√°lisis de Red - Telecomunicaciones</title>
  <meta name="theme-color" content="#667eea" />
  <!-- XLSX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    :root { --grad1:#667eea; --grad2:#764ba2; --bg:#ffffff; --muted:#7f8c8d; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, var(--grad1) 0%, var(--grad2) 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
    .header { background: linear-gradient(135deg, var(--grad1) 0%, var(--grad2) 100%); color: white; padding: 22px; text-align: center; }
    .header h1 { font-size: 2em; margin-bottom: 6px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
    .header p { font-size: 1em; opacity: 0.92; }
    .controls { background: #f8f9fa; padding: 14px 18px; border-bottom: 2px solid #e9ecef; display: grid; grid-template-columns: 1fr 1fr; gap: 10px 16px; align-items: center; }
    .control-group { display:flex; flex-wrap:wrap; gap:8px; align-items:center; padding-left:8px; border-left:3px solid #667eea; }
    .group-title { font-weight:700; color:#667eea; font-size:10px; letter-spacing:.6px; }
    .btn { padding: 10px 12px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 6px; }
    .btn-primary { background: linear-gradient(135deg, var(--grad1) 0%, var(--grad2) 100%); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4); }
    .btn-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; }
    .btn-success:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(56, 239, 125, 0.4); }
    input[type="file"] { display:none; }
    .controls input[type="datetime-local"], .controls input[type="text"], .controls select { padding:8px; border:1px solid #e5e7eb; border-radius:8px; font-size:13px; background:#fff; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 14px; padding: 18px; }
    .stat-card { background: white; border-radius: 12px; padding: 14px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); border-left: 4px solid var(--grad1); }
    .stat-card .stat-value { font-size: 1.6em; font-weight: 800; color: #111827; }
    .stat-card .stat-label { color: #6b7280; font-size: 0.8em; text-transform: uppercase; letter-spacing: .5px; }
    .preview-section { padding: 18px; min-height: 360px; }
    .preview-title { font-size: 1.2em; color: #111827; font-weight: 700; margin-bottom: 8px; }
    .table-container { background: white; border-radius: 12px; overflow-x: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
    table { width: 100%; border-collapse: collapse; }
    th { background: linear-gradient(135deg, var(--grad1) 0%, var(--grad2) 100%); color: white; padding: 10px; text-align: left; font-weight: 700; position: sticky; top: 0; z-index: 1; font-size: 12px; }
    td { padding: 9px 10px; border-bottom: 1px solid #ecf0f1; font-size: 12px; }
    tr:hover { background: #f8f9fa; }
    .priority-badge { display: inline-block; padding: 3px 8px; border-radius: 16px; font-size: 0.72em; font-weight: 800; text-transform: uppercase; }
    .priority-critica { background: #e74c3c; color: white; }
    .priority-alta { background: #e67e22; color: white; }
    .priority-media { background: #f39c12; color: white; }
    .priority-baja { background: #95a5a6; color: white; }
    .loading { text-align:center; padding:40px; color: #6b7280; }
    .spinner { border:4px solid #f3f3f3; border-top:4px solid var(--grad1); border-radius:50%; width:36px; height:36px; animation: spin 1s linear infinite; margin: 0 auto 12px; }
    @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
    .tabs { display:flex; gap:10px; padding:0 18px; border-bottom:2px solid #ecf0f1; background:#f8f9fa; }
    .tab { padding: 10px 14px; background: transparent; border: none; cursor: pointer; font-size: 13px; font-weight: 700; color: #6b7280; border-bottom:3px solid transparent; }
    .tab.active { color: var(--grad1); border-bottom-color: var(--grad1); background: white; }
    .hidden { display:none; }
    footer { padding:10px; text-align:center; color:#6b7280; background:#f8f9fa; font-size:.85em; }
    .switch { position: relative; display: inline-block; width: 46px; height: 22px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #d1d5db; transition: .3s; border-radius: 22px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%; }
    input:checked + .slider { background-color: #667eea; }
    input:checked + .slider:before { transform: translateX(24px); }
    .spark { display:flex; gap:3px; align-items:flex-end; height:16px; }
    .spark > i { display:block; width:6px; background:#c7d2fe; border-radius:2px; }
    .spark > i.hot { background:#818cf8; }
    .row-critical-down { background: #fee2e2 !important; }
    .zone-tools { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:8px 0; }
    .pill { display:inline-block; padding:2px 6px; border-radius:10px; font-size:11px; background:#eef2ff; color:#3730a3; font-weight:700; }
    .checkbox-ot { transform: scale(1.1); } /* === Fix superposici√≥n: modal por encima de headers sticky === */
.modal { z-index: 9999 !important; }
.modal-content { position: relative; z-index: 10000; }

/* Evitar scroll del fondo cuando el modal est√° abierto */
body.modal-open { overflow: hidden; }

/* Mini-charts en la cabecera del modal */
.zone-mini {
  display: grid;
  grid-template-columns: 1fr;
  gap: 8px;
  margin: 8px 0 12px 0;
}
.mini-title { font-weight: 800; color:#111827; font-size: 12px; }
.mini-chart, .hour-chart {
  display:flex; align-items:flex-end; gap:4px; height:42px;
}
.mini-chart i, .hour-chart i {
  display:block; width:12px; background:#c7d2fe; border-radius:2px;
}
.mini-chart i.hot { background:#6366f1; }
.hour-chart i.hot { background:#8b5cf6; }
.mini-legend { color:#6b7280; font-size:11px; display:flex; justify-content:space-between; }

  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üåê Panel de An√°lisis de Red</h1>
      <p>Priorizaci√≥n N/N-1, ventana N..N-k, merge multi-reportes, salud y nodos UP/DOWN</p>
    </div>

    <div class="controls">
      <!-- Reportes A/B -->
      <div class="control-group">
        <span class="group-title">REPORTES</span>
        <label for="fileInput" class="btn btn-primary">üìÅ Reporte A</label>
        <input type="file" id="fileInput" accept=".xlsx,.xls" />
        <label for="fileInputB" class="btn">‚ûï Reporte B</label>
        <input type="file" id="fileInputB" accept=".xlsx,.xls" />
        <label style="display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="toggleMergeB" />
          <span>Cruzar con B</span>
        </label>
      </div>

      <!-- Filtros base -->
      <div class="control-group">
        <span class="group-title">FILTROS BASE</span>
        <div style="display:flex;align-items:center;gap:6px;">
          <label class="switch"><input type="checkbox" id="toggleInstalaciones" checked><span class="slider"></span></label>
          <span style="font-weight:700;color:#374151;font-size:12px;">Incluir Instalaciones</span>
        </div>
        <label style="display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="onlyFTTH" />
          <span>Solo FTTH (9xx)</span>
        </label>
        <label style="display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="excludeFTTH" />
          <span>Excluir FTTH</span>
        </label>
        <label style="color:#6b7280;font-weight:700;">Ventana</label>
        <select id="daysWindow">
          <option value="3" selected>√öltimos 3 d√≠as</option>
          <option value="7">√öltimos 7 d√≠as</option>
          <option value="14">√öltimos 14 d√≠as</option>
        </select>
      </div>

      <!-- Rango & B√∫squeda -->
      <div class="control-group">
        <span class="group-title">RANGO & B√öSQUEDA</span>
        <label style="color:#6b7280;font-weight:700;">Desde</label>
        <input id="startInput" type="datetime-local">
        <label style="color:#6b7280;font-weight:700;">Hasta</label>
        <input id="endInput" type="datetime-local">
        <button class="btn" id="applyFiltersBtn" style="background:#111827;color:#fff;">Aplicar</button>
        <button class="btn" id="clearFiltersBtn" style="background:#374151;color:#fff;">Limpiar</button>
        <input id="quickSearch" type="text" placeholder="Buscar por zona o direcci√≥n..." style="min-width:230px;">
      </div>

      <!-- Salud + Nodos -->
      <div class="control-group">
        <span class="group-title">SALUD & NODOS</span>
        <label for="fileInputHealth" class="btn">üíì Salud (CombinedData)</label>
        <input type="file" id="fileInputHealth" accept=".xlsx,.xls" />
        <label style="display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="toggleUseHealth" />
          <span>Usar salud</span>
        </label>

        <label for="fileInputNodes" class="btn">üß≠ Up&Down Nodes</label>
        <input type="file" id="fileInputNodes" accept=".xlsx,.xls" />

        <button class="btn" id="clearHealthBtn" style="background:#ef4444;color:#fff;">üßπ Limpiar salud/nodos</button>

        <div id="healthFilters" style="display:none;align-items:center;gap:8px;">
          <label style="color:#6b7280;font-weight:700;">Zona C</label>
          <select id="healthZoneSelect"></select>
          <label style="color:#6b7280;font-weight:700;">Estado</label>
          <select id="healthStateSelect">
            <option value="all" selected>Todos</option>
            <option value="up">Solo UP</option>
            <option value="down">Solo DOWN</option>
          </select>
          <span id="healthCounters" class="pill">‚Äî</span>
        </div>
      </div>

      <!-- Export global -->
      <div class="control-group" style="justify-content:flex-end; border-left-color:#10b981;">
        <span id="fileName" style="color:#6b7280;"></span>
        <button class="btn btn-success" id="downloadBtn" style="display:none;">üíæ Exportar Excel Global</button>
      </div>
    </div>

    <div id="alertSection"></div>
    <div id="statsSection" class="stats-grid hidden"></div>

<div class="tabs hidden" id="tabsSection">
  <button class="tab active" data-tab="edificios">üè¢ Edificios</button>
  <button class="tab" data-tab="zonas">üìç Zonas</button>
  <button class="tab" data-tab="diagnosticos">‚ö° Diagn√≥sticos</button>
  <button class="tab" data-tab="dispositivos">üì± Dispositivos</button>
</div>


    <div id="previewSection" class="preview-section">
      <div class="loading">
        <div class="spinner"></div>
        <p>Esperando archivo...</p>
        <p style="margin-top:8px;font-size:.9em;">Carg√° el Reporte A para comenzar</p>
      </div>
    </div>
  </div>

  <!-- Modal de zona -->
  <div id="zoneModal" class="modal" aria-hidden="true" aria-labelledby="modalTitle" role="dialog" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);">
    <div class="modal-content" style="background:#fff;margin:5% auto;padding:0;border-radius:12px;width:90%;max-width:1100px;max-height:80vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.3);">
      <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; padding:16px; display:flex; justify-content:space-between; align-items:center;">
        <h2 id="modalTitle">Detalles de Zona</h2>
        <button class="close" id="closeModalBtn" aria-label="Cerrar" style="color:#fff;font-size:24px;font-weight:800;background:none;border:none;">&times;</button>
      </div>
      <div class="modal-body" id="modalBody" style="padding:16px; max-height: calc(80vh - 64px); overflow:auto;"></div>
    </div>
  </div>

 <footer id="footerInfo">v4.0 ‚Ä¢ Merge A/B ‚Ä¢ FTTH 9xx ‚Ä¢ Salud y Nodos ‚Ä¢ Export por zona/eco</footer>

<script>
  /* ========= ESTADO GLOBAL ========= */
  let processedData = null;
  let currentTab = 'edificios';

  let dataRowsA = null;      // Reporte A
  let dataRowsB = null;      // Reporte B
  let useMergeB = false;

  let globalDataRows = null; // compat de algunas funciones
  let currentFilteredRows = null;
  let zoneDetailsMap = {};

  let includeInstalaciones = true;
  let onlyFTTH = false;
  let excludeFTTH = false;

  let filterRange = { start: null, end: null };
  let DAYS_WINDOW = 3;              // Ventana N..N-(k-1)
  const HORIZON_K = 7;              // Horizonte para sparkline
  const DAY_MS = 86400000;

  let nodeToCmts = new Map();
  
  /* ========= DIAGN√ìSTICOS (clasificaci√≥n) ========= */
  const DIAGNOSTIC_CATEGORIES = {
    EQUIPMENT_DAMAGE: {
      keywords: ['da√±ado','quemado','falla fuente','no enciende','cortocircuito','sobretension','sobre tensi√≥n','sobre-tensi√≥n'],
      severity: 'CR√çTICO', color: '#dc2626', icon: '‚ö°'
    },
    SIGNAL_ISSUES: {
      keywords: ['sin se√±al','no recibe se√±al','baja se√±al','intermitente','microcorte','micro-corte'],
      severity: 'ALTO', color: '#ea580c', icon: 'üì°'
    },
    CONNECTIVITY: {
      keywords: ['inconveniente de interface wifi','no navega','lento','desconecta','sin internet'],
      severity: 'MEDIO', color: '#ca8a04', icon: 'üåê'
    },
    INSTALLATION: {
      keywords: ['instalacion','configuracion','activacion'],
      severity: 'BAJO', color: '#16a34a', icon: 'üîß'
    }
  };
  function categorizeDiagnostic(diagnostic) {
    const diagLower = (diagnostic || '').toLowerCase();
    for (const [category, cfg] of Object.entries(DIAGNOSTIC_CATEGORIES)) {
      if (cfg.keywords.some(k => diagLower.includes(k))) return { category, ...cfg };
    }
    return { category: 'OTHER', severity: 'BAJO', color: '#6b7280', icon: '‚ùì' };
  }

  // Salud / Nodos
  let healthByZone = new Map(); // Map<ZONA, Map<MAC, {estado:0|1, ts?:number}>>
  let useHealth = false;
  let selectedHealthZone = null;
  let selectedHealthState = 'all';
  let nodesByZone = new Map();  // Map<ZONA, {up:number, down:number}>

  /* ========= UTILS ========= */
  function parseDate(str) {
    if (!str) return null;
    const clean = String(str).trim().replace(',', ' ');
    const [datePart, timePart] = clean.split(/\s+/);
    const [d,m,y] = (datePart || '').split('/').map(Number);
    if (!d || !m || !y) return null;
    const [hh,mm] = (timePart || '00:00').split(':').map(v => parseInt(v||'0',10));
    return new Date(y, m-1, d, hh||0, mm||0, 0);
  }
  const toDayKey = (date) => new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime();
  const normStr = (s) => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\./g,' ').replace(/,/g,' ').replace(/\s+/g,' ').trim().toUpperCase();
  function isFTTHZone(z){ const m=String(z||'').match(/[A-Z]{2,}(\d{3,})/); return !!(m && m[1].startsWith('9')); }
  function inDaysWindow(dateStr, days){
    const dt = parseDate(dateStr); if (!dt) return false;
    const today = new Date(); today.setHours(0,0,0,0);
    const from = new Date(today.getTime() - (days-1)*DAY_MS);
    const end  = new Date(today.getTime() + (24*60*60*1000 - 1));
    return dt >= from && dt <= end;
  }
  function sparkline(counts){
    const max = Math.max(1, ...counts);
    const days = ['Hoy','Ayer','N-2','N-3','N-4','N-5','N-6','N-7','N-8'];
    return '<div class="spark">' + counts.map((c,i)=>{
      const h = Math.max(3, Math.round(14*c/max));
      const hot = (i<=1 && c>=3) ? ' hot' : '';
      const label = (days[i]||('N-'+i))+': '+c+' OTs';
      return `<i class="${hot}" style="height:${h}px" title="${label}"></i>`;
    }).join('') + '</div>';
  }
  const normMac = (mac) => String(mac||'').toUpperCase().replace(/[^0-9A-F]/g, '');
  function updateFooterInfo(){
    const el = document.getElementById('footerInfo');
    el.textContent = `v4.0 ‚Ä¢ Merge A/B ‚Ä¢ FTTH 9xx ‚Ä¢ Salud y Nodos ‚Ä¢ Export por zona/eco ‚Ä¢ √öltimo an√°lisis: ${new Date().toLocaleString()}`;
  }
// Normaliza zonas/nodos para que coincidan con las de A/B
function canonicalizeZone(z) {
  return String(z || '')
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .toUpperCase().replace(/\s+/g,' ').trim()
    .replace(/^ZONA\s*C\s*/,'C')  // "ZONA C123" -> "C123"
    .replace(/^ZONA\s*/,'')       // "ZONA 123"  -> "123"
    .replace(/^CMTS\s*/,'')       // "CMTS C123" -> "C123"
    .replace(/-/g,'');            // "C-123"     -> "C123"
}

function toInt(val) {
  if (val == null || val === '') return 0;
  if (typeof val === 'number') return Math.round(val);
  const s = String(val).trim().replace(/\./g,'').replace(/,/g,'.');
  const n = parseFloat(s.replace(/[^\d.-]/g,''));
  return isNaN(n) ? 0 : Math.round(n);
}

function findHeaderRow(rows) {
  for (let i = 0; i < Math.min(50, rows.length); i++) {
    const rowStr = (rows[i] || []).map(v => String(v || '').toLowerCase()).join(' ');
    const hasZonaNodo = /zona|nodo|cmts|zone|node/.test(rowStr);
    const hasCounts   = /up|down|caidos|ca√≠do|offline|online|downstream|upstream/.test(rowStr);
    if (hasZonaNodo && hasCounts) return i;
  }
  return -1;
}

  /* ========= LISTENERS ========= */
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('fileInput').addEventListener('change', handleFileSelectA);
    document.getElementById('fileInputB').addEventListener('change', handleFileSelectB);
    document.getElementById('toggleMergeB').addEventListener('change', e => { useMergeB = e.target.checked; applyCurrentFilters(); });

    document.getElementById('toggleInstalaciones').addEventListener('change', e => { includeInstalaciones = e.target.checked; applyCurrentFilters(); });
    document.getElementById('onlyFTTH').addEventListener('change', e => { onlyFTTH = e.target.checked; if (onlyFTTH){ excludeFTTH=false; document.getElementById('excludeFTTH').checked=false; } applyCurrentFilters(); });
    document.getElementById('excludeFTTH').addEventListener('change', e => { excludeFTTH = e.target.checked; if (excludeFTTH){ onlyFTTH=false; document.getElementById('onlyFTTH').checked=false; } applyCurrentFilters(); });
    document.getElementById('daysWindow').addEventListener('change', e => { DAYS_WINDOW = parseInt(e.target.value||'3',10); applyCurrentFilters(); });

    document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
    document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);

    let searchTimeout;
    document.getElementById('quickSearch').addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => { if (processedData) displayData(currentTab); }, 300);
    });

    // Salud + Nodos
    document.getElementById('fileInputHealth').addEventListener('change', handleFileSelectHealth);
    document.getElementById('fileInputNodes').addEventListener('change', handleFileSelectNodes);
    document.getElementById('toggleUseHealth').addEventListener('change', (e) => {
      useHealth = e.target.checked;
      document.getElementById('healthFilters').style.display = useHealth && healthByZone.size ? 'flex' : 'none';
      if (currentTab === 'dispositivos') displayData('dispositivos');
    });
    document.getElementById('clearHealthBtn').addEventListener('click', () => {
      healthByZone.clear(); nodesByZone.clear(); useHealth=false; selectedHealthZone=null; selectedHealthState='all';
      document.getElementById('toggleUseHealth').checked=false;
      document.getElementById('healthFilters').style.display='none';
      if (processedData) displayData(currentTab);
    });
    document.getElementById('healthZoneSelect').addEventListener('change', e => { selectedHealthZone = e.target.value || null; if (currentTab==='dispositivos') displayData('dispositivos'); });
    document.getElementById('healthStateSelect').addEventListener('change', e => { selectedHealthState = e.target.value; if (currentTab==='dispositivos') displayData('dispositivos'); });

    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function(){
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        currentTab = this.dataset.tab;
        if (processedData) displayData(currentTab);
      });
    });

    // Modal
    document.getElementById('closeModalBtn').addEventListener('click', closeModal);
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
    window.addEventListener('click', (e) => { const modal = document.getElementById('zoneModal'); if (e.target === modal) closeModal(); });

    // Export global
    document.getElementById('downloadBtn').addEventListener('click', downloadAnalysis);

    updateFooterInfo();
  });

  /* ========= PARSERS / LOADERS ========= */
  async function handleFileSelectA(e) {
    const file = e.target.files[0]; if (!file) return;
    document.getElementById('fileName').textContent = 'üìÑ ' + file.name;
    showLoading('Procesando Reporte A...');
    try {
      const data = new Uint8Array(await file.arrayBuffer());
      const wb = XLSX.read(data, { type:'array', cellDates:true });
      dataRowsA = extractRowsFromWorkbook(wb);
      globalDataRows = dataRowsA;
      document.getElementById('downloadBtn').style.display = 'inline-flex';
      document.getElementById('statsSection').classList.remove('hidden');
      document.getElementById('tabsSection').classList.remove('hidden');
      document.getElementById('alertSection').innerHTML = '';
      applyCurrentFilters();
    } catch(err){ showError('Error al leer Reporte A: ' + err.message); }
  }
  async function handleFileSelectB(e) {
    const file = e.target.files[0]; if (!file) return;
    try {
      const data = new Uint8Array(await file.arrayBuffer());
      const wb = XLSX.read(data, { type:'array', cellDates:true });
      dataRowsB = extractRowsFromWorkbook(wb);
      applyCurrentFilters();
    } catch(err){ showError('Error al leer Reporte B: ' + err.message); }
  }

  function extractRowsFromWorkbook(workbook){
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    if (!sheet) return [];
    const jsonData = XLSX.utils.sheet_to_json(sheet, { header:1, defval:'', raw:true });

    // buscar header (fila que contenga 'fecha' y 'zona')
    let headerRow = -1;
    for (let i=0;i<Math.min(50,jsonData.length);i++){
      const row = jsonData[i]||[];
      const rowStr = row.join(' ').toLowerCase();
      if (rowStr.includes('fecha') && rowStr.includes('zona')) { headerRow = i; break; }
    }
    if (headerRow === -1) headerRow = 0;

    const headers = (jsonData[headerRow]||[]).map(h=>String(h||'').trim().toLowerCase());
    const findCol = (cands) => {
      for (const c of cands){
        let idx = headers.findIndex(h => h===c);
        if (idx!==-1) return idx;
        idx = headers.findIndex(h => h.includes(c));
        if (idx!==-1) return idx;
      }
      return -1;
    };

    const cFechaHora = findCol(['fecha/hora','fecha/hora de apertura','fecha y hora','fecha hora','fecha_hora','fechahora','fecha completa','datetime']);
    const cFechaSolo = findCol(['fecha/hora','fecha/hora de apertura','fecha creaci√≥n','fecha creacion','fecha','fecha alta']);
    const cHora      = findCol(['hora','hora creaci√≥n','hora creacion']);
    const cZonaHFC = findCol(['zona tecnica hfc','zona hfc','zona hfc/cmts','zona hfc/nodo','zona']);
    const cCalle   = findCol(['calle','direccion','direcci√≥n']);
    const cTel     = findCol(['telefono','tel√©fono']);
    const cCaso    = findCol(['numero de caso','nro caso','caso','id caso']);
    const cOrden   = findCol(['numero de orden','nro orden','orden']);
    const cEco     = findCol(['externalcaseid','eco','external case id']);
    const cDiag    = findCol(['diagnostico tecnico','diagn√≥stico t√©cnico','diagnostico','diagn√≥stico']);
    const cCita    = findCol(['numero de cita','nro cita','cita','ot','sa']);
    const cZonaFT  = findCol(['zona tecnica ftth','zona ftth']);
    const cGlobal  = findCol(['globalidexttkt','global id ext tkt','global id']);
    const cTrabajo = findCol(['tipo de trabajo','tipo trabajo','trabajo']);
    const cEstado1 = findCol(['estado','estado 1','estado1']);
    const cEstado2 = findCol(['estado 2','estado2']);
    const cEstado3 = findCol(['estado 3','estado3']);
    const cTerr    = findCol(['territorio','region','regi√≥n']);
    const cInfoDev = findCol(['info dispositivos','dispositivos','equipos','deviceinfo','info equipos']);

    const rows = [];
    const citas = new Set();

    const fmt2 = (n)=>String(n).padStart(2,'0');
    const toStrDateTime = (valFecha, valHora) => {
      const fromAny = (v) => {
        if (v instanceof Date) return v;
        if (typeof v === 'number') {
          const p = XLSX.SSF.parse_date_code(v);
          if (p) return new Date(Date.UTC(p.y, p.m-1, p.d, p.H||0, p.M||0, p.S||0));
          return null;
        }
        const s = String(v).trim().replace(',', ' ');
        if (!s) return null;
        if (/\d{1,2}\/\d{1,2}\/\d{2,4}[\s,]+\d{1,2}:\d{2}/.test(s)) return s;
        const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
        if (m) return new Date(Number(m[3].length===2?'20'+m[3]:m[3]), Number(m[2])-1, Number(m[1]));
        return s;
      };

      let d = fromAny(valFecha);
      let hh=0,mm=0;
      if (valHora != null && valHora !== ''){
        if (valHora instanceof Date){ hh=valHora.getHours(); mm=valHora.getMinutes(); }
        else if (typeof valHora === 'number'){
          const frac = valHora - Math.floor(valHora);
          const totalMin = Math.round(frac*24*60);
          hh = Math.floor(totalMin/60); mm = totalMin%60;
        } else {
          const hm = String(valHora).trim().match(/(\d{1,2}):(\d{2})/);
          if (hm){ hh=Number(hm[1]); mm=Number(hm[2]); }
        }
      }

      if (d instanceof Date && !isNaN(d.getTime())){
        return `${fmt2(d.getDate())}/${fmt2(d.getMonth()+1)}/${d.getFullYear()} ${fmt2(hh)}:${fmt2(mm)}`;
      }
      if (typeof d === 'string'){
        if (valHora && !/\d{1,2}:\d{2}/.test(d)) return `${d} ${fmt2(hh)}:${fmt2(mm)}`;
        return d;
      }
      return '';
    };

    for (let i=headerRow+1; i<jsonData.length; i++){
      const r = jsonData[i] || [];
      const fechaStr = toStrDateTime(
        (cFechaHora !== -1 ? r[cFechaHora] : (cFechaSolo !== -1 ? r[cFechaSolo] : (r[0]||''))),
        (cHora !== -1 ? r[cHora] : '')
      );
      if (!fechaStr) continue;

      const rowData = {
        fechaCreacion: String(fechaStr),
        zonaTecnicaHFC: cZonaHFC !== -1 ? (r[cZonaHFC] || '') : '',
        calle:          cCalle   !== -1 ? (r[cCalle]   || '') : '',
        telefono:       cTel     !== -1 ? (r[cTel]     || '') : '',
        numeroCaso:     cCaso    !== -1 ? (r[cCaso]    || '') : '',
        numeroOrden:    cOrden   !== -1 ? (r[cOrden]   || '') : '',
        externalCaseId: cEco     !== -1 ? (r[cEco]     || '') : '',
        diagnosticoTecnico: cDiag !== -1 ? (r[cDiag]   || '') : '',
        numeroCita:     cCita    !== -1 ? (r[cCita]    || '') : '',
        zonaTecnicaFTTH:cZonaFT  !== -1 ? (r[cZonaFT]  || '') : '',
        globalIdExtTkt: cGlobal  !== -1 ? (r[cGlobal]  || '') : '',
        tipoTrabajo:    cTrabajo !== -1 ? (r[cTrabajo] || '') : '',
        estado1:        cEstado1 !== -1 ? (r[cEstado1] || '') : '',
        estado2:        cEstado2 !== -1 ? (r[cEstado2] || '') : '',
        estado3:        cEstado3 !== -1 ? (r[cEstado3] || '') : '',
        territorio:     cTerr    !== -1 ? (r[cTerr]    || '') : '',
        infoDispositivos: cInfoDev !== -1 ? (r[cInfoDev] || '') : ''
      };

      if (rowData.numeroCita){
        if (!citas.has(rowData.numeroCita)) { citas.add(rowData.numeroCita); rows.push(rowData); }
      } else if ((rowData.calle || '').trim() && (rowData.zonaTecnicaHFC || rowData.zonaTecnicaFTTH)){
        rows.push(rowData);
      }
    }
    return rows;
  }

  /* ========= MERGE y FILTROS ========= */
  function mergeDatasets(baseRows, otherRows){
    if (!otherRows || !otherRows.length) return baseRows.slice();
    const citas = new Set(baseRows.map(r=>r.numeroCita).filter(Boolean));
    const out = baseRows.map(r => ({...r, _origen:'A'}));
    otherRows.forEach(r => {
      const mark = {...r, _origen:'B'};
      if (r.numeroCita){
        if (!citas.has(r.numeroCita)) { citas.add(r.numeroCita); out.push(mark); }
      } else {
        const keyB = (r.calle||'') + '|' + r.fechaCreacion;
        const dup = out.find(x => (x.calle||'')+'|'+x.fechaCreacion === keyB);
        if (!dup) out.push(mark);
      }
    });
    return out;
  }

  function applyFilters(){
    const s = document.getElementById('startInput').value;
    const e = document.getElementById('endInput').value;
    filterRange.start = s ? new Date(s) : null;
    filterRange.end   = e ? new Date(e) : null;
    applyCurrentFilters();
  }
  function clearFilters(){
    document.getElementById('startInput').value = '';
    document.getElementById('endInput').value = '';
    filterRange = { start:null, end:null };
    applyCurrentFilters();
  }

  function applyCurrentFilters(){
    let rows = dataRowsA || [];
    if (useMergeB && dataRowsB && dataRowsB.length) rows = mergeDatasets(rows, dataRowsB);

    if (!includeInstalaciones) rows = rows.filter(r => !(r.tipoTrabajo||'').toUpperCase().includes('INSTALACION'));
    if (onlyFTTH) rows = rows.filter(r => isFTTHZone(r.zonaTecnicaHFC || r.zonaTecnicaFTTH));
    else if (excludeFTTH) rows = rows.filter(r => !isFTTHZone(r.zonaTecnicaHFC || r.zonaTecnicaFTTH));

    if (filterRange.start || filterRange.end) {
      rows = rows.filter(r => {
        const dt = parseDate(r.fechaCreacion); if (!dt) return false;
        if (filterRange.start && dt < filterRange.start) return false;
        if (filterRange.end && dt > filterRange.end) return false;
        return true;
      });
    } else {
      const rowsByWindow = rows.filter(r => inDaysWindow(r.fechaCreacion, DAYS_WINDOW));
      rows = rowsByWindow.length ? rowsByWindow : rows;
      if (!rowsByWindow.length) {
        document.getElementById('alertSection').innerHTML =
          `<div style="padding:10px;margin:10px;border-left:4px solid #f59e0b;background:#fffbeb;color:#92400e;border-radius:8px;">
             No hay datos dentro de "√öltimos ${DAYS_WINDOW} d√≠as". Mostrando todo el reporte.
           </div>`;
      } else document.getElementById('alertSection').innerHTML = '';
    }

    currentFilteredRows = rows;
    processedData = analyzeData(currentFilteredRows);
    updateZoneDetailsMap(currentFilteredRows);
    displayStatistics(processedData);
    displayData(currentTab);
    updateFooterInfo();
  }

  /* ========= MAPA PARA MODAL POR ZONA ========= */
  function updateZoneDetailsMap(rows){
    zoneDetailsMap = {};
    rows.forEach(r => {
      const zones = [];
      if (r.zonaTecnicaHFC) zones.push(r.zonaTecnicaHFC);
      if (r.zonaTecnicaFTTH) zones.push(r.zonaTecnicaFTTH);
      zones.forEach(z => {
        if (!zoneDetailsMap[z]) zoneDetailsMap[z] = [];
        zoneDetailsMap[z].push(r);
      });
    });
  }

  /* ========= ANAL√çTICA ========= */
  function analyzeData(rows){
    const result = { zonas: [], resumenDiario: [], dispositivos: [], stats: {} };

    // ---- Agrupar por zona
    const zoneGroups = {};
    const citasPorZona = {};
    rows.forEach(r => {
      const zone = r.zonaTecnicaHFC || r.zonaTecnicaFTTH;
      if (zone && zone.trim() !== '') {
        if (!zoneGroups[zone]) { zoneGroups[zone] = []; citasPorZona[zone] = new Set(); }
        zoneGroups[zone].push(r);
        if (r.numeroCita) citasPorZona[zone].add(r.numeroCita);
      }
    });

    // ---- M√©tricas por zona
    Object.entries(zoneGroups).forEach(([zona, casos]) => {
      const seenOTperDay = new Map(); // dayEpoch -> Set(OT)
      casos.forEach(c => {
        const dt = parseDate(c.fechaCreacion); if (!dt) return;
        const dk = toDayKey(dt);
        if (!seenOTperDay.has(dk)) seenOTperDay.set(dk, new Set());
        const ot = c.numeroCita || ((c.calle || '') + '|' + c.fechaCreacion);
        seenOTperDay.get(dk).add(ot);
      });

      const todayEpoch   = toDayKey(new Date());
      const ingresoN     = seenOTperDay.get(todayEpoch)?.size || 0;
      const ingresoN1    = seenOTperDay.get(todayEpoch - DAY_MS)?.size || 0;
      const diasConCasos = Array.from(seenOTperDay.values()).filter(s => s.size > 0).length;
      const maxOTsEnUnDia= Math.max(0, ...Array.from(seenOTperDay.values()).map(s => s.size));

      const otSet = new Set();
      casos.forEach(c => otSet.add(c.numeroCita || ((c.calle||'') + '|' + c.fechaCreacion)));
      const totalOTs = otSet.size || casos.length;

      const nivelRiesgo  = (ingresoN >= 3 || ingresoN1 >= 3) ? 'CR√çTICO' : (maxOTsEnUnDia >= 3 ? 'ALTO' : 'MEDIO');

      const nodo = nodesByZone.get(canonicalizeZone(zona)) || { up: 0, down: 0 };

      // Diagn√≥sticos
      const diagnosticMap = new Map();    // category -> {count, cases[], color, icon, severity, category}
      const dailyDiagnostics = new Map(); // dayEpoch -> Map(category -> count)
      casos.forEach(c => {
        const diag = c.diagnosticoTecnico || 'Sin diagn√≥stico';
        const cat  = categorizeDiagnostic(diag);
        if (!diagnosticMap.has(cat.category)) diagnosticMap.set(cat.category, { count:0, cases:[], ...cat });
        const entry = diagnosticMap.get(cat.category);
        entry.count++; entry.cases.push(c);

        const dt = parseDate(c.fechaCreacion);
        if (dt){
          const dayKey = toDayKey(dt);
          if (!dailyDiagnostics.has(dayKey)) dailyDiagnostics.set(dayKey, new Map());
          const m = dailyDiagnostics.get(dayKey);
          m.set(cat.category, (m.get(cat.category)||0) + 1);
        }
      });

      // % CATEC sobre OTs √∫nicas
      const otCATEC = new Set();
      casos.forEach(c => {
        const t = (c.tipoTrabajo||'').toUpperCase();
        if (t.includes('CATEC')) {
          const ot = c.numeroCita || ((c.calle||'') + '|' + c.fechaCreacion);
          otCATEC.add(ot);
        }
      });
      const catecCount = otCATEC.size;
      const catecRate  = totalOTs ? (catecCount / totalOTs) * 100 : 0;

      // √öltimos 7 d√≠as por d√≠a de semana (0=Dom..6=S√°b)
      const start7 = new Date(); start7.setHours(0,0,0,0); start7.setDate(start7.getDate()-6);
      const weekCounts = Array(7).fill(0);
      casos.forEach(c => {
        const dt = parseDate(c.fechaCreacion); if (!dt) return;
        if (dt >= start7) weekCounts[dt.getDay()]++;
      });

     result.zonas.push({
  zona,
  totalOTs,
  diasConCasos,
  ingresoN,
  ingresoN1,
  maxOTsEnUnDia,
  nivelRiesgo,
  territorio: (casos[0]?.territorio) || '',
  cmsUp: Number(nodo.up || 0),
  cmsDown: Number(nodo.down || 0),
  cmts: nodeToCmts.get(canonicalizeZone(zona)) || '',   // <-- NUEVO
  diagnosticos: Array.from(diagnosticMap.values()),
  dailyDiagnostics,
  catecCount,
  catecRate: Number(catecRate.toFixed(1)),
  weekCounts
});
      });

    // Ordenar zonas: primero N/N-1, luego volumen
    result.zonas.sort((a,b) =>
      (b.ingresoN  - a.ingresoN)  ||
      (b.ingresoN1 - a.ingresoN1) ||
      (b.totalOTs  - a.totalOTs)
    );

    // ---- Resumen diario
    const dailyGroups = {}; const citasPorDia = {};
    rows.forEach(r => {
      const f = r.fechaCreacion;
      if (!dailyGroups[f]) { dailyGroups[f] = []; citasPorDia[f] = new Set(); }
      dailyGroups[f].push(r);
      if (r.numeroCita) citasPorDia[f].add(r.numeroCita);
    });
    Object.entries(dailyGroups).forEach(([fecha, casos]) => {
      const zonesSet = new Set(); let casosService = 0; let casosInst = 0;
      const citasContadas = new Set();
      casos.forEach(c => {
        if (c.zonaTecnicaHFC) zonesSet.add(c.zonaTecnicaHFC);
        if (c.zonaTecnicaFTTH) zonesSet.add(c.zonaTecnicaFTTH);
        if (!c.numeroCita || !citasContadas.has(c.numeroCita)) {
          if (c.numeroCita) citasContadas.add(c.numeroCita);
          const t = (c.tipoTrabajo||'').toUpperCase();
          if (t.includes('SERVICE')) casosService++;
          if (t.includes('INSTALACION')) casosInst++;
        }
      });
      const totalOTsDia = citasPorDia[fecha].size || casos.length;
      result.resumenDiario.push({
        fecha,
        totalOTs: totalOTsDia,
        zonasAfectadas: zonesSet.size,
        casosService,
        casosInstalacion: casosInst
      });
    });
    result.resumenDiario.sort((a,b)=> (parseDate(a.fecha) - parseDate(b.fecha)));

    // ---- Dispositivos
    const dispositivosMap = {};
    const citasAnalizadas = new Set();
    rows.forEach(r => {
      if (r.numeroCita && citasAnalizadas.has(r.numeroCita)) return;
      if (r.numeroCita) citasAnalizadas.add(r.numeroCita);

      const devices = parseDeviceInfo(r.infoDispositivos);
      devices.forEach(dev => {
        const key = (dev.type||'')+'_'+(dev.serial||'')+'_'+(dev.mac||'');
        if (!dispositivosMap[key]) {
          const zona = (r.zonaTecnicaHFC || r.zonaTecnicaFTTH || '').toUpperCase();
          let estadoSalud = 'S/C';
          if (useHealth && healthByZone.size && dev.mac) {
            const mapaZ = healthByZone.get(zona);
            if (mapaZ) {
              const entry = mapaZ.get(normMac(dev.mac));
              if (entry) estadoSalud = (entry.estado === 1) ? 'UP' : 'DOWN';
            }
          }
          dispositivosMap[key] = {
            tipo: dev.type || '',
            modelo: dev.model || '',
            serial: dev.serial || '',
            mac: dev.mac || '',
            marca: dev.category || '',
            zona: zona || '',
            estadoSalud,
            apariciones: []
          };
        }
        dispositivosMap[key].apariciones.push({
          zona: r.zonaTecnicaHFC || r.zonaTecnicaFTTH || '',
          direccion: r.calle,
          fecha: r.fechaCreacion,
          ot: r.numeroCita || 'Sin OT'
        });
      });
    });
    Object.values(dispositivosMap).forEach(d => {
      if ((d.mac && d.mac.trim()) || d.apariciones.length > 1) result.dispositivos.push(d);
    });
    result.dispositivos.sort((a,b)=> b.apariciones.length - a.apariciones.length);

    // ---- Stats
    const totalCitasUnicas = new Set(rows.map(r=>r.numeroCita).filter(Boolean)).size;
    result.stats = {
      totalOTs: totalCitasUnicas || rows.length,
      totalZonas: result.zonas.length,
      dispositivosProblematicos: result.dispositivos.length,
      diasAnalizados: result.resumenDiario.length
    };

    return result;
  }

  /* ========= PARSE DEVICES ========= */
  function parseDeviceInfo(infoStr){
    const devices = [];
    if (!infoStr || !String(infoStr).trim()) return devices;
    let s = String(infoStr).trim();

    try { // JSON (objeto o array)
      let candidate = s;
      if (!/^\s*\[/.test(candidate) && /^\s*\{/.test(candidate)) candidate = `[${candidate}]`;
      if (candidate.includes("'") && !candidate.includes('"')) candidate = candidate.replace(/'/g,'"');
      const parsed = JSON.parse(candidate);
      const arr = Array.isArray(parsed) ? parsed : [parsed];
      arr.forEach(obj => {
        if (!obj || typeof obj !== 'object') return;
        const device = {
          category: obj.category || obj.Category || '',
          model: obj.model || obj.Model || '',
          serial: obj.serialNumber || obj.SerialNumber || obj.serial || '',
          mac: obj.macAddress || obj.MAC || obj.Mac || '',
          type: obj.type || obj.Type || '',
          description: obj.description || obj.Description || ''
        };
        if (!device.type && device.description){
          const d = device.description.toLowerCase();
          if (d.includes('cable')) device.type='Cablemodem';
          else if (d.includes('ont')) device.type='ONT';
          else if (d.includes('deco')) device.type='Deco';
        }
        devices.push(device);
      });
      if (devices.length) return devices;
    } catch(_){}

    // Fallback regex
    try{
      const getAll = (re) => Array.from(s.matchAll(re)).map(m => (m[1]||'').trim());
      const cats   = getAll(/"category"\s*:\s*"([^"]*)"/ig);
      const models = getAll(/"model"\s*:\s*"([^"]*)"/ig);
      const serials= getAll(/"serialNumber"\s*:\s*"([^"]*)"/ig);
      const macs   = getAll(/"macAddress"\s*:\s*"([^"]*)"/ig);
      const types  = getAll(/"type"\s*:\s*"([^"]*)"/ig);
      const descs  = getAll(/"description"\s*:\s*"([^"]*)"/ig);
      const n = Math.max(cats.length, models.length, serials.length, macs.length, types.length, descs.length);
      for (let i=0;i<n;i++){
        const d = {
          category: cats[i]||'',
          model: models[i]||'',
          serial: serials[i]||'',
          mac: macs[i]||'',
          type: types[i]||'',
          description: descs[i]||''
        };
        if (!d.type && d.description){
          const t = d.description.toLowerCase();
          if (t.includes('cable')) d.type='Cablemodem';
          else if (t.includes('ont')) d.type='ONT';
          else if (t.includes('deco')) d.type='Deco';
        }
        devices.push(d);
      }
    } catch(e){}
    return devices;
  }

  /* ========= SALUD (CombinedData) ========= */
  const parseTimestamp = (val) => { if (!val && val!==0) return null; const d=new Date(val); return isNaN(d.getTime())?null:d.getTime(); };
  function upsertHealth(zona, mac, estado, ts){
    if (!zona || !mac) return;
    const z = String(zona).trim().toUpperCase();
    const m = normMac(mac);
    if (!healthByZone.has(z)) healthByZone.set(z, new Map());
    const zoneMap = healthByZone.get(z);
    const prev = zoneMap.get(m);
    if (!prev) zoneMap.set(m, { estado, ts: ts || null });
    else if ((ts||0) >= (prev.ts||0)) zoneMap.set(m, { estado, ts: ts || null });
  }
  async function handleFileSelectHealth(e){
    const file = e.target.files[0]; if (!file) return;
    try{
      const data = new Uint8Array(await file.arrayBuffer());
      const wb = XLSX.read(data, { type:'array', cellDates:true });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { header:1, defval:'', raw:false });
      let start = 0; if (rows.length && String(rows[0][0]).toLowerCase().includes('mac')) start = 1;
      for (let i=start;i<rows.length;i++){
        const r = rows[i]; if (!r || r.length<3) continue;
        const mac = r[0]; const zona = r[1]; const estadoRaw = r[2];
        if (estadoRaw==='' || estadoRaw===null || typeof estadoRaw==='undefined') continue;
        const estado = Number(estadoRaw); if (estado!==0 && estado!==1) continue;
        const ts = parseTimestamp(r[3]);
        upsertHealth(zona, mac, estado, ts);
      }
      const zoneSel = document.getElementById('healthZoneSelect');
      zoneSel.innerHTML = '<option value="">Todas</option>' + Array.from(healthByZone.keys()).sort().map(z => `<option value="${z}">${z}</option>`).join('');
      selectedHealthZone = null;

      useHealth = true;
      document.getElementById('toggleUseHealth').checked = true;
      document.getElementById('healthFilters').style.display = healthByZone.size ? 'flex' : 'none';
      if (currentTab === 'dispositivos') displayData('dispositivos');
    } catch(err){ showError('Error al leer CombinedData: ' + err.message); }
  }

  /* ========= UP & DOWN NODES ========= */
 async function handleFileSelectNodes(e){
  const file = e.target.files[0]; if (!file) return;
  nodesByZone.clear();
  nodeToCmts.clear();

  try{
    const data = new Uint8Array(await file.arrayBuffer());
    const wb = XLSX.read(data, { type:'array', cellDates:true });
    const sh = wb.Sheets[wb.SheetNames[0]];

    // raw:true evita formatos raros (separadores, etc.)
    const rows = XLSX.utils.sheet_to_json(sh, { header:1, defval:'', raw:true });
    if (!rows.length) return;

    // Detectar encabezado
    const headerRow = findHeaderRow(rows);
    let hdr = [], start = 0;
    if (headerRow !== -1){
      hdr = (rows[headerRow] || []).map(x => String(x || '').toLowerCase());
      start = headerRow + 1;
    }

    const findCol = (cands) => {
      for (const c of cands){
        const idx = hdr.findIndex(h => h.includes(c));
        if (idx !== -1) return idx;
      }
      return -1;
    };

    // Columnas (seg√∫n tu captura: Fecha | CMTS | Nodo | Up | Down | Unknown)
    let cmtsCol = findCol(['cmts']);
    let nodoCol = findCol(['nodo','node']);     // preferimos Nodo como ‚Äúzona‚Äù
    let upCol   = findCol(['up','online','activos','upstream']);
    let dnCol   = findCol(['down','offline','caidos','ca√≠do','downstream']);

    // Sin header claro: asumir [*, CMTS, Nodo, Up, Down]
    if (headerRow === -1){
      if (cmtsCol === -1) cmtsCol = 1;
      if (nodoCol === -1) nodoCol = 2;
      if (upCol   === -1) upCol   = 3;
      if (dnCol   === -1) dnCol   = 4;
    }

    let parsed = 0;
    for (let i = start; i < rows.length; i++){
      const r = rows[i]; if (!r || !r.length) continue;

      const nodoRaw = nodoCol !== -1 ? r[nodoCol] : (r[0] ?? '');
      const zonaKey = canonicalizeZone(nodoRaw);
      if (!zonaKey) continue;

      const cmtsVal = cmtsCol !== -1 ? String(r[cmtsCol] || '').toUpperCase().trim() : '';
      if (cmtsVal) {
        // Guardamos el mapeo Nodo -> CMTS (la √∫ltima ocurrencia gana)
        nodeToCmts.set(zonaKey, cmtsVal);
      }

      const up   = toInt(upCol !== -1 ? r[upCol] : 0);
      const down = toInt(dnCol !== -1 ? r[dnCol] : 0);

      const prev = nodesByZone.get(zonaKey) || { up:0, down:0 };
      nodesByZone.set(zonaKey, { up: prev.up + up, down: prev.down + down });
      parsed++;
    }

    if (processedData && currentTab === 'zonas') displayData('zonas');
    if (!parsed) showError('No se pudieron leer filas de Up&Down Nodes. Revis√° encabezados: CMTS / Nodo / Up / Down.');

  } catch(err){
    showError('Error al leer Up&Down Nodes: ' + err.message);
  }
}

  /* ========= STATS & SWITCH DE RENDER ========= */
  function displayStatistics(proc){
    if (!proc){ document.getElementById('statsSection').classList.add('hidden'); return; }
    const s = proc.stats || {};
    const html = `
      <div class="stat-card"><div class="stat-value">${s.totalOTs||0}</div><div class="stat-label">OTs √∫nicas</div></div>
      <div class="stat-card"><div class="stat-value">${s.totalZonas||0}</div><div class="stat-label">Zonas</div></div>
      <div class="stat-card"><div class="stat-value">${s.dispositivosProblematicos||0}</div><div class="stat-label">Dispositivos</div></div>
      <div class="stat-card"><div class="stat-value">${s.diasAnalizados||0}</div><div class="stat-label">D√≠as analizados</div></div>`;
    const cont = document.getElementById('statsSection');
    cont.innerHTML = html;
    cont.classList.remove('hidden');
  }

  function displayData(tab){
    if (!processedData) return;
    let html = '';
    if (tab === 'edificios') html = displayEdificios();
    else if (tab === 'zonas') html = displayZonas(processedData.zonas);
    else if (tab === 'diagnosticos') html = displayDiagnosticos(processedData.zonas);
    else if (tab === 'dispositivos') html = displayDispositivos(processedData.dispositivos);
    document.getElementById('previewSection').innerHTML = html;
  }

  /* ========= HELPERS DE RENDER ========= */
  function showLoading(txt){
    document.getElementById('previewSection').innerHTML =
      '<div class="loading"><div class="spinner"></div><p>'+txt+'</p></div>';
  }
  function showError(message){
    document.getElementById('previewSection').innerHTML = `
      <div style="padding:14px 18px; margin:12px; border-left:4px solid #e74c3c; background:#fdecea; color:#9f3a38; border-radius:8px;">
        <strong>Error:</strong> ${message}
      </div>`;
  }

  // ==== Heatmap d√≠a √ó hora ====
  function buildWeekHourMatrix(rows){
    const M = Array.from({length:7},()=>Array(24).fill(0));
    rows.forEach(r=>{
      const dt = parseDate(r.fechaCreacion); if(!dt) return;
      const dow = (dt.getDay()+7)%7;
      const h   = dt.getHours();
      if (h>=0 && h<24) M[dow][h]++;
    });
    return M;
  }
  function renderWeekHourHeatmap(rows){
    const M = buildWeekHourMatrix(rows||[]);
    const max = Math.max(1, ...M.flat());
    const dow = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];

    const legend = `
      <div style="display:flex;align-items:center;gap:8px;margin:8px 0;">
        <span style="font-size:12px;color:#6b7280">Bajo</span>
        <div style="display:flex;gap:4px;">
          ${[0.2,0.4,0.6,0.8,1].map(a=>`<div style="width:18px;height:12px;background:rgba(99,102,241,${a});border-radius:2px;"></div>`).join('')}
        </div>
        <span style="font-size:12px;color:#6b7280">Alto</span>
      </div>`;

    let html = `<div class="preview-title">üïí Patrones de demanda (d√≠a √ó hora)</div>${legend}`;
    html += '<div class="table-container" style="overflow:auto">';
    html += '<table style="border-collapse:collapse;width:max-content">';
    html += '<thead><tr><th style="position:sticky;left:0;background:linear-gradient(135deg, var(--grad1) 0%, var(--grad2) 100%);color:#fff;padding:6px 8px;">D√≠a</th>';
    for (let h=0; h<24; h++) html += `<th style="background:linear-gradient(135deg, var(--grad1) 0%, var(--grad2) 100%);color:#fff;padding:6px 8px;font-size:12px;">${String(h).padStart(2,'0')}</th>`;
    html += '</tr></thead><tbody>';

    M.forEach((row,i)=>{
      html += `<tr>`;
      html += `<td style="position:sticky;left:0;background:#fff;font-weight:700;padding:6px 8px;border-bottom:1px solid #ecf0f1;">${dow[i]}</td>`;
      row.forEach(v=>{
        const alpha = 0.15 + 0.85*(v/max);
        html += `<td title="${v} OTs" style="width:22px;height:22px;background:rgba(99,102,241,${alpha});border:1px solid #fff;"></td>`;
      });
      html += `</tr>`;
    });

    html += '</tbody></table></div>';
    return html;
  }

  // === Debe estar a nivel superior (se usa en varias vistas) ===
  function renderWeekBars(weekCounts){
    const order = [1,2,3,4,5,6,0]; // Lun..Dom
    const labels = ['L','M','X','J','V','S','D'];
    const data = order.map(i => Number(weekCounts?.[i] || 0));
    const max = Math.max(1, ...data);
    const bars = data.map((c, idx) => {
      const h = Math.max(3, Math.round((c / max) * 30));
      return `<div title="${labels[idx]}: ${c}" style="width:10px;height:${h}px;background:#6366f1;border-radius:2px;"></div>`;
    }).join('');
    return `<div style="display:flex;align-items:flex-end;gap:4px;height:36px;">${bars}</div>`;
  }

  function badgeNivel(item){
    if ((item.countN||0) >= 3 || (item.countN1||0) >= 3) return '<span class="priority-badge priority-critica">CR√çTICO</span>';
    if ((item.maxEnUnDia||0) >= 3) return '<span class="priority-badge priority-alta">ALTO</span>';
    return '<span class="priority-badge priority-media">MEDIO</span>';
  }
  function deltaBadge(n, n1){
    const d = (n||0) - (n1||0);
    if (d===0) return '<span class="pill" style="background:#eef2ff;color:#3730a3;">=</span>';
    const up = d>0;
    const color = up ? '#dc2626' : '#16a34a';
    const sym = up ? '‚ñ≤' : '‚ñº';
    const pct = (n1||0) > 0 ? Math.round(Math.abs(d)/n1*100) : 100;
    return `<span class="pill" style="background:${up?'#fee2e2':'#dcfce7'};color:${color};">${sym} ${Math.abs(d)} (${pct}%)</span>`;
  }

  function macFromRow(r){
    const devs = parseDeviceInfo(r.infoDispositivos);
    const d = devs.find(x => x.mac && x.mac.trim());
    return d ? d.mac.trim().toUpperCase() : '';
  }

  // ===== Ranking Edificios =====
  function toEpochDay(dt){ return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate()).getTime(); }
  function buildDailyMap(rows){
    const map = new Map(); // dirCanon -> Map(dayEpoch -> Set(OT))
    const info = new Map();
    rows.forEach(r => {
      const dt = parseDate(r.fechaCreacion); if (!dt) return;
      const day = toEpochDay(dt);
      const dir = normStr(r.calle || 'SIN DIRECCION');
      const ot = r.numeroCita || (dir + '|' + r.fechaCreacion);
      if (!map.has(dir)) map.set(dir, new Map());
      if (!map.get(dir).has(day)) map.get(dir).set(day, new Set());
      map.get(dir).get(day).add(ot);
      if (!info.has(dir)) info.set(dir, r);
    });
    return { map, info };
  }
  function vectorCounts(perDayMap, todayEpoch, kHorizon){
    const counts=[]; let maxEnUnDia=0, diasActivos=0, total=0;
    for (let i=0;i<=kHorizon;i++){
      const d = todayEpoch - i*DAY_MS;
      const set = perDayMap.get(d);
      const c = set ? set.size : 0;
      counts.push(c);
      if (c>0) diasActivos++;
      if (c>maxEnUnDia) maxEnUnDia = c;
      total += c;
    }
    const arr = counts.slice(1);
    const mean = arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
    const variance = arr.length ? arr.reduce((a,b)=>a+(b-mean)*(b-mean),0)/arr.length : 0;
    const std = Math.sqrt(variance);
    const zN = std>0 ? (counts[0]-mean)/std : 0;
    const densidad = diasActivos ? total/diasActivos : 0;
    return { counts, maxEnUnDia, diasActivos, densidad, zN, total };
  }
  function scoreAcople(counts, maxEnUnDia, densidad, zN){
    const weights=[1.00,0.70,0.50,0.35,0.25,0.18,0.13,0.09];
    let s = 0;
    for (let i=0;i<counts.length && i<weights.length;i++) s += counts[i]*weights[i];
    s += 0.15*maxEnUnDia + 0.20*densidad + 0.25*Math.max(0,zN);
    return s;
  }
  function buildBuildingsRank(rows){
    const today = new Date(); const todayEpoch = toEpochDay(today);
    const { map, info } = buildDailyMap(rows);
    const list = [];
    map.forEach((perDayMap, dirCanon) => {
      const { counts, maxEnUnDia, densidad, zN, total } = vectorCounts(perDayMap, todayEpoch, Math.max(HORIZON_K, DAYS_WINDOW-1));
      const sample = info.get(dirCanon) || {};
      const countN = counts[0]||0, countN1 = counts[1]||0;
      const score = scoreAcople(counts, maxEnUnDia, densidad, zN);
      list.push({
        dirCanon,
        direccion: sample.calle || 'SIN DIRECCION',
        zonaHFC: sample.zonaTecnicaHFC || '',
        zonaFTTH: sample.zonaTecnicaFTTH || '',
        territorio: sample.territorio || '',
        counts, maxEnUnDia, score, total,
        countN, countN1
      });
    });
    const filtered = list.filter(x => (x.total || 0) >= 3);
    const top = filtered
      .filter(x => (x.countN>0 || x.countN1>0))
      .sort((a,b)=> (b.countN - a.countN) || (b.countN1 - a.countN1) || (b.maxEnUnDia - a.maxEnUnDia) || (b.score - a.score));
    const rest = filtered
      .filter(x => !(x.countN>0 || x.countN1>0))
      .sort((a,b)=> (b.score - a.score) || (b.maxEnUnDia - a.maxEnUnDia) || (b.countN1 - a.countN1) || (b.countN - a.countN));
    return { top, rest };
  }

  // ===== Render: Edificios =====
  function displayEdificios(){
    const base = currentFilteredRows || [];
    if (!base.length) return '<div class="loading"><p>No hay datos para mostrar.</p></div>';

    const q = (document.getElementById('quickSearch')?.value || '').trim().toLowerCase();
    const frows = q
      ? base.filter(r =>
          (r.calle || '').toLowerCase().includes(q) ||
          (r.zonaTecnicaHFC || '').toLowerCase().includes(q) ||
          (r.zonaTecnicaFTTH || '').toLowerCase().includes(q))
      : base;

    const { top, rest } = buildBuildingsRank(frows);

    const head = `
      <thead>
        <tr>
          <th>Direcci√≥n</th><th>Zona HFC</th><th>Zona FTTH</th><th>Territorio</th>
          <th>N/N-1</th><th>M√°x D√≠a</th><th>Score</th><th>√öltimos ${Math.max(DAYS_WINDOW, HORIZON_K)} d√≠as</th><th>Criticidad</th>
        </tr>
      </thead>`;

    const rowTpl = (e) => `
      <tr>
        <td>${e.direccion}</td>
        <td>${e.zonaHFC || '-'}</td>
        <td>${e.zonaFTTH || '-'}</td>
        <td>${e.territorio || '-'}</td>
        <td><strong>${e.countN}</strong>/<strong>${e.countN1}</strong></td>
        <td>${e.maxEnUnDia}</td>
        <td>${e.score.toFixed(2)}</td>
        <td>${sparkline(e.counts)}</td>
        <td>${badgeNivel(e)}</td>
      </tr>`;

    const topHTML = top.length
      ? `<div class="preview-title">üèÅ Prioridad N/N-1 (Hoy/Ayer)</div>
         <div class="table-container"><table>${head}<tbody>${top.map(rowTpl).join('')}</tbody></table></div>`
      : `<div class="preview-title">üèÅ Prioridad N/N-1</div><div class="loading"><p>Sin direcciones prioritarias en N/N-1</p></div>`;

    const restHTML = rest.length
      ? `<div class="preview-title" style="margin-top:12px;">üìã Resto N..N-${DAYS_WINDOW-1} (‚â•3 OTs)</div>
         <div class="table-container"><table>${head}<tbody>${rest.map(rowTpl).join('')}</tbody></table></div>`
      : '';

    return topHTML + restHTML;
  }

  // ===== Render: Zonas =====
  function displayZonas(zonas){
    if (!zonas.length) return '<div class="loading"><p>No se encontraron zonas</p></div>';
    const q = (document.getElementById('quickSearch')?.value || '').trim().toLowerCase();
    const arr = q ? zonas.filter(z => (z.zona||'').toLowerCase().includes(q)) : zonas;

    const head = `
      <thead>
        <tr>
          <th>Zona</th>
          <th>Total OTs</th>
          <th>Ingreso N</th>
          <th>Ingreso N-1</th>
          <th>% CATEC</th>
          <th>Ingresos 7d (L..D)</th>
          <th>Territorio</th>
          <th>CMS UP</th>
          <th>CMS DOWN</th>
          <th>Acci√≥n</th>
        </tr>
      </thead>`;

    const rows = arr.map(z => {
      const rowClass = (z.nivelRiesgo === 'CR√çTICO' && Number(z.cmsDown||0)>0) ? ' class="row-critical-down"' : '';
      return `
        <tr${rowClass}>
          <td><strong>${z.zona}</strong></td>
          <td>${z.totalOTs}</td>
          <td>${z.ingresoN} ${deltaBadge(z.ingresoN, z.ingresoN1)}</td>
          <td>${z.ingresoN1}</td>
          <td><strong>${(z.catecRate||0)}%</strong> <span class="pill">${z.catecCount||0} CATEC</span></td>
          <td>${renderWeekBars(z.weekCounts||[])}</td>
          <td>${z.territorio || '-'}</td>
          <td>${Number(z.cmsUp||0)}</td>
          <td>${Number(z.cmsDown||0)}</td>
          <td><button class="btn" onclick="openZoneModal('${z.zona.replace(/'/g,"&#39;")}')">üîé Ver</button></td>
        </tr>`;
    }).join('');

    return `
      <div class="preview-title">üìç An√°lisis de Zonas</div>
      <div class="table-container"><table>${head}<tbody>${rows}</tbody></table></div>`;
  }

  /* === Series para minigr√°ficos del modal === */
  function zoneBuildTimeSeries(zoneRows){
    const dayCounts  = Array(7).fill(0); // index 0 = N-6 ... index 6 = N
    const hourCounts = Array(24).fill(0);
    const todayEpoch = toDayKey(new Date());

    zoneRows.forEach(r => {
      const dt = parseDate(r.fechaCreacion); if (!dt) return;
      const h = dt.getHours(); if (h>=0 && h<24) hourCounts[h]++;
      const dk = toDayKey(dt);
      const diffDays = Math.round((todayEpoch - dk) / DAY_MS); // 0=hoy
      if (diffDays >= 0 && diffDays < 7){
        const idx = 6 - diffDays; // N-6..N
        dayCounts[idx]++;
      }
    });
    return { dayCounts, hourCounts };
  }
  function zoneMiniChartsHTML(zoneRows){
    const { dayCounts, hourCounts } = zoneBuildTimeSeries(zoneRows);
    const maxDay = Math.max(1, ...dayCounts);
    const maxHour = Math.max(1, ...hourCounts);
    const dayBars = dayCounts.map(c => `<i class="${c>0?'hot':''}" style="height:${Math.max(3, Math.round((c/maxDay)*40))}px"></i>`).join('');
    const hourBars= hourCounts.map(c => `<i class="${c>0?'hot':''}" style="height:${Math.max(2, Math.round((c/maxHour)*40))}px"></i>`).join('');
    return `
      <div class="zone-mini">
        <div>
          <div class="mini-title">Ingresos √∫ltimos 7 d√≠as (N-6 ‚Üí N)</div>
          <div class="mini-chart" title="${dayCounts.join(', ')}">${dayBars}</div>
          <div class="mini-legend"><span>N-6</span><span>N</span></div>
        </div>
        <div>
          <div class="mini-title">Distribuci√≥n horaria (0‚Äì23)</div>
          <div class="hour-chart">${hourBars}</div>
          <div class="mini-legend"><span>00</span><span>23</span></div>
        </div>
      </div>`;
  }
  function buildDamageTrendChart(dailyDiagnostics){
    if (!dailyDiagnostics || dailyDiagnostics.size===0) return '<span style="color:#9ca3af;">Sin datos</span>';
    const today = toDayKey(new Date());
    const damageCounts = [];
    for (let i=6; i>=0; i--){
      const dayKey = today - (i * DAY_MS);
      const m = dailyDiagnostics.get(dayKey);
      const c = m ? (m.get('EQUIPMENT_DAMAGE') || 0) : 0;
      damageCounts.push(c);
    }
    const maxDamage = Math.max(1, ...damageCounts);
    const bars = damageCounts.map(count => {
      const h = Math.max(3, (count / maxDamage) * 20);
      const color = count > 3 ? '#dc2626' : count > 1 ? '#ea580c' : '#9ca3af';
      return `<div style="width:8px;height:${h}px;background:${color};margin:0 1px;" title="${count} equipos da√±ados"></div>`;
    }).join('');
    return `<div style="display:flex;align-items:flex-end;height:24px;">${bars}</div>`;
  }

  // ===== Diagn√≥sticos (tabla) =====
  function displayDiagnosticos(zonas){
    if (!zonas.length) return '<div class="loading"><p>No se encontraron datos de diagn√≥sticos</p></div>';
    const q = (document.getElementById('quickSearch')?.value || '').trim().toLowerCase();
    const arr = q ? zonas.filter(z => (z.zona||'').toLowerCase().includes(q)) : zonas;

    const sorted = arr.slice().sort((a,b) => {
      const ad = (a.diagnosticos||[]).reduce((s,d)=>s+(d.count||0),0);
      const bd = (b.diagnosticos||[]).reduce((s,d)=>s+(d.count||0),0);
      return (b.totalOTs - a.totalOTs) || (bd - ad);
    });

    const head = `
      <thead>
        <tr>
          <th>Zona</th>
          <th>Total OTs</th>
          <th>Distribuci√≥n por categor√≠a</th>
          <th>Ingresos 7d</th>
          <th>Acci√≥n</th>
        </tr>
      </thead>`;

    const rows = sorted.map(z => {
      const diags = z.diagnosticos || [];
      const maxCount = Math.max(1, ...diags.map(d => d.count||0));
      const diagChart = diags.map(d => {
        const w = Math.max(10, (d.count / maxCount) * 80);
        return `<div style="display:flex;align-items:center;gap:6px;margin:3px 0;">
          <span style="font-size:11px;">${d.icon}</span>
          <span style="font-size:11px;min-width:110px;color:#374151;">${d.category}</span>
          <div style="width:${w}px;height:12px;background:${d.color};border-radius:2px;" title="${d.category}: ${d.count}"></div>
          <span style="font-size:11px;color:#6b7280;">${d.count}</span>
        </div>`;
      }).join('');

      return `
        <tr>
          <td><strong>${z.zona}</strong></td>
          <td>${z.totalOTs}</td>
          <td><div style="min-width:260px;">${diagChart || '<span style="color:#9ca3af;">Sin categor√≠as</span>'}</div></td>
          <td>${renderWeekBars(z.weekCounts||[])}</td>
          <td><button class="btn" onclick="openZoneModal('${z.zona.replace(/'/g,"&#39;")}')">üîç Detalles</button></td>
        </tr>`;
    }).join('');

    return `
      <div class="preview-title">‚ö° Tipos de ingresos por zona</div>
      <div class="table-container"><table>${head}<tbody>${rows}</tbody></table></div>`;
  }

  function analyzeDiagnosticsForZone(rows){
    if (!rows || !rows.length) return 'Sin datos.';
    const counts = new Map();
    rows.forEach(r => {
      const cat = categorizeDiagnostic(r.diagnosticoTecnico || '').category;
      counts.set(cat, (counts.get(cat)||0) + 1);
    });
    const total = rows.length;
    const top = Array.from(counts.entries()).sort((a,b)=>b[1]-a[1]).slice(0,6);
    const catec = rows.reduce((s,r)=> s + (((r.tipoTrabajo||'').toUpperCase().includes('CATEC'))?1:0), 0);
    const catecPct = Math.round((catec/total)*100);
    const parts = top.map(([cat,c]) => `${cat}: <strong>${c}</strong> (${Math.round(c*100/total)}%)`);
    parts.push(`% CATEC: <strong>${catecPct}%</strong> (${catec} de ${total})`);
    return parts.join(' ‚Ä¢ ');
  }

  // ===== Modal de Zona =====
  function openZoneModal(zona){
    const modal = document.getElementById('zoneModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    modalTitle.textContent = 'üìç Zona: ' + zona;
    const cmtsForZone = nodeToCmts.get(canonicalizeZone(zona)) || '‚Äî';


    const zoneData = (zoneDetailsMap && zoneDetailsMap[zona]) ? zoneDetailsMap[zona] : [];
    if (!zoneData.length) {
      modalBody.innerHTML = '<p>No hay datos disponibles para esta zona</p>';
      modal.style.display = 'block'; modal.setAttribute('aria-hidden','false');
      document.body.classList.add('modal-open');
      return;
    }

    let html = `
      <div class="zone-tools">
        <button class="btn btn-success" onclick="downloadZoneExcel('${zona.replace(/'/g,"&#39;")}')">üì• Excel Zona</button>
        <button class="btn" style="background:#111827;color:#fff;" onclick="exportSelectedEcoTXT('${zona.replace(/'/g,"&#39;")}')">üìù Exportar ECO (TXT)</button>
        <label style="display:flex;align-items:center;gap:6px;margin-left:auto;">
          <input type="checkbox" id="chkAllZone" onchange="toggleAllZoneChecks(this)">
          <span>Seleccionar todo</span>
        </label>
      </div>`;
    const diagnosticAnalysis = analyzeDiagnosticsForZone(zoneData);
    html += `
      <div style="background:#fef3c7;border-left:4px solid #f59e0b;padding:10px;margin:8px 0;border-radius:8px;">
        <strong>üìä An√°lisis de Diagn√≥sticos:</strong><br>${diagnosticAnalysis}
      </div>`;
    html += `
  <div style="display:flex;gap:8px;align-items:center;margin:6px 0 8px 0;">
    <span class="pill" style="background:#e0f2fe;color:#075985;">CMTS: ${cmtsForZone}</span>
  </div>`;

    html += zoneMiniChartsHTML(zoneData);

    // Agrupar por fecha y por OT
    const dayMap = new Map();
    zoneData.forEach(r => {
      const dt = parseDate(r.fechaCreacion);
      const key = dt ? toDayKey(dt) : r.fechaCreacion;
      if (!dayMap.has(key)) dayMap.set(key, []);
      dayMap.get(key).push(r);
    });
    const days = Array.from(dayMap.keys()).sort((a,b)=> b-a);

    days.forEach(dayKey => {
      const list = dayMap.get(dayKey);
      const byOT = new Map();
      list.forEach(r => {
        const ot = r.numeroCita || 'Sin OT';
        if (!byOT.has(ot)) byOT.set(ot, []);
        byOT.get(ot).push(r);
      });
      const fechaHuman = (typeof dayKey === 'number') ? new Date(dayKey).toLocaleDateString() : String(dayKey);
      html += `<div style="margin:10px 0 6px 0;"><span class="pill">Fecha: ${fechaHuman}</span></div>`;

      byOT.forEach((registros, ot) => {
        const first = registros[0];
        const mac = macFromRow(first) || '-';
        const eco = first.externalCaseId || '';
        const tipo = first.tipoTrabajo || '-';
        const estadoLegado = first.estado1 || '-';
        const direccion = first.calle || '-';
        const caso = first.numeroCaso || '-';

        html += `
          <div class="ot-card" style="background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin-bottom:8px;">
            <div class="ot-header" style="display:flex;align-items:center;gap:8px;justify-content:space-between;border-bottom:1px solid #f3f4f6;padding-bottom:8px;margin-bottom:8px;">
              <div>
                <input class="checkbox-ot" type="checkbox" data-eco="${eco}" />
                <span class="pill">OT: ${ot}</span>
              </div>
              <div style="color:#6b7280;">ECO: <strong>${eco || '-'}</strong></div>
            </div>
            <div class="ot-details" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;">
              <div><div class="detail-label">Caso</div><div class="detail-value">${caso}</div></div>
              <div><div class="detail-label">Direcci√≥n</div><div class="detail-value">${direccion}</div></div>
              <div><div class="detail-label">Trabajo</div><div class="detail-value">${tipo}</div></div>
              <div><div class="detail-label">MAC</div><div class="detail-value">${mac}</div></div>
              <div><div class="detail-label">eco</div><div class="detail-value">${eco || '-'}</div></div>
              <div><div class="detail-label">Estado cita legado</div><div class="detail-value">${estadoLegado}</div></div>
            </div>
          </div>`;
      });
    });

    modalBody.innerHTML = html;
    modal.style.display = 'block';
    modal.setAttribute('aria-hidden','false');
    document.body.classList.add('modal-open');
  }
  function closeModal(){
    const modal=document.getElementById('zoneModal');
    modal.style.display='none';
    modal.setAttribute('aria-hidden','true');
    document.body.classList.remove('modal-open');
  }
  function toggleAllZoneChecks(chk){
    const modalBody = document.getElementById('modalBody');
    modalBody.querySelectorAll('.checkbox-ot').forEach(c => { c.checked = chk.checked; });
  }
  function exportSelectedEcoTXT(zona){
    const modalBody = document.getElementById('modalBody');
    const ecos = [];
    modalBody.querySelectorAll('.checkbox-ot:checked').forEach(c => {
      const eco = c.getAttribute('data-eco');
      if (eco && eco.trim()) ecos.push(eco.trim());
    });
    if (!ecos.length){ alert('No seleccionaste OTs con eco.'); return; }
    const txt = ecos.join('\n');
    downloadText(`ECO_${zona}.txt`, txt);
  }
  function downloadText(filename, content){
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
  function downloadZoneExcel(zona){
    const zoneData = (zoneDetailsMap && zoneDetailsMap[zona]) ? zoneDetailsMap[zona] : [];
    if (!zoneData.length){ alert('Sin datos para la zona ' + zona); return; }
    const rows = zoneData.map(r => ({
      Fecha: r.fechaCreacion,
      ZonaHFC: r.zonaTecnicaHFC || '',
      ZonaFTTH: r.zonaTecnicaFTTH || '',
      Territorio: r.territorio || '',
      Direccion: r.calle || '',
      Caso: r.numeroCaso || '',
      NumeroOrden: r.numeroOrden || '',
      NumeroCita: r.numeroCita || '',
      eco: r.externalCaseId || '',
      Diagnostico: r.diagnosticoTecnico || '',
      TipoTrabajo: r.tipoTrabajo || '',
      EstadoLegado: r.estado1 || '',
      Estado2: r.estado2 || '',
      Estado3: r.estado3 || '',
      MAC: macFromRow(r) || ''
    }));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rows), `Zona_${zona.substring(0,25)}`);
    XLSX.writeFile(wb, `Reporte_Zona_${zona}.xlsx`);
  }

  // ===== Resumen (opcional en UI) =====
  function displayResumen(items){
    if (!items.length) return '<div class="loading"><p>Sin datos de resumen</p></div>';
    const head = `
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Total OTs</th>
          <th>Zonas afectadas</th>
          <th>Service</th>
          <th>Instalaci√≥n</th>
        </tr>
      </thead>`;
    const rows = items.map(i => `
      <tr>
        <td>${i.fecha}</td>
        <td>${i.totalOTs}</td>
        <td>${i.zonasAfectadas}</td>
        <td>${i.casosService}</td>
        <td>${i.casosInstalacion}</td>
      </tr>`).join('');
    return `<div class="preview-title">üìä Resumen Diario</div>
      <div class="table-container"><table>${head}<tbody>${rows}</tbody></table></div>`;
  }

  // ===== Dispositivos =====
  function displayDispositivos(devs){
    let src = devs.slice();
    if (useHealth && healthByZone.size){
      if (selectedHealthZone) src = src.filter(d => String(d.zona||'').toUpperCase() === String(selectedHealthZone).toUpperCase());
      if (selectedHealthState === 'up') src = src.filter(d => d.estadoSalud === 'UP');
      if (selectedHealthState === 'down') src = src.filter(d => d.estadoSalud === 'DOWN');
    }
    if (useHealth && healthByZone.size && src.length === 0) return '<div class="loading"><p>No hay dispositivos que coincidan con los filtros de salud</p></div>';
    if (!src.length) return '<div class="loading"><p>Sin dispositivos para mostrar</p></div>';

    if (useHealth && healthByZone.size){
      let up=0, down=0;
      src.forEach(d => { if (d.estadoSalud === 'UP') up++; else if (d.estadoSalud === 'DOWN') down++; });
      const span = document.getElementById('healthCounters');
      if (span) span.textContent = `UP: ${up} ‚Ä¢ DOWN: ${down} ‚Ä¢ Total: ${src.length}`;
    }

    const head = `
      <thead>
        <tr>
          <th>Tipo</th><th>Modelo</th><th>Serial</th><th>MAC</th>
          <th>Marca</th><th>Zona</th><th>Salud</th><th>Apariciones</th>
        </tr>
      </thead>`;

    const rows = src.slice(0,500).map(d => {
      const salud = d.estadoSalud === 'UP' ? '<span class="priority-badge" style="background:#10b981;color:#fff;">UP</span>'
                  : d.estadoSalud === 'DOWN' ? '<span class="priority-badge" style="background:#ef4444;color:#fff;">DOWN</span>'
                  : '<span class="priority-badge" style="background:#9ca3af;color:#fff;">S/C</span>';
      return `
        <tr>
          <td>${d.tipo||'-'}</td>
          <td>${d.modelo||'-'}</td>
          <td>${d.serial||'-'}</td>
          <td>${(d.mac||'').toUpperCase()}</td>
          <td>${d.marca||'-'}</td>
          <td>${d.zona||'-'}</td>
          <td>${salud}</td>
          <td>${d.apariciones.length}</td>
        </tr>`;
    }).join('');

    if (useHealth && healthByZone.size){
      document.getElementById('healthFilters').style.display = 'flex';
      const zoneSel = document.getElementById('healthZoneSelect');
      if (zoneSel && !zoneSel.options.length){
        zoneSel.innerHTML = '<option value="">Todas</option>' + Array.from(healthByZone.keys()).sort().map(z => `<option value="${z}">${z}</option>`).join('');
      }
    }

    return `<div class="preview-title">üì± Dispositivos (agrupados MAC/Serial) ‚Äî m√°x 500</div>
      <div class="table-container"><table>${head}<tbody>${rows}</tbody></table></div>`;
  }

  /* ========= EXPORT GLOBAL (Excel) ========= */
  function downloadAnalysis(){
    if (!processedData){ alert('No hay datos procesados.'); return; }
    const wb = XLSX.utils.book_new();

    const { top, rest } = buildBuildingsRank(currentFilteredRows || []);
    const rowsEd = [...top, ...rest].map(e => ({
      Direccion: e.direccion,
      ZonaHFC: e.zonaHFC || '',
      ZonaFTTH: e.zonaFTTH || '',
      Territorio: e.territorio || '',
      N: e.countN,
      N_1: e.countN1,
      MaxDia: e.maxEnUnDia,
      Score: Number(e.score.toFixed(2)),
      TotalUltimos: e.total
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rowsEd), 'Edificios');

    const rowsZ = processedData.zonas.map(z => ({
      Zona: z.zona,
      CMTS: z.cmts || '',
      TotalOTs: z.totalOTs,
      DiasConOTs: z.diasConCasos,
      IngresoN: z.ingresoN,
      IngresoN1: z.ingresoN1,
      MaxEnUnDia: z.maxOTsEnUnDia,
      Criticidad: z.nivelRiesgo,
      Territorio: z.territorio || '',
      CMS_UP: Number(z.cmsUp||0),
      CMS_DOWN: Number(z.cmsDown||0)
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rowsZ), 'Zonas');

    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(processedData.resumenDiario), 'Resumen');

    const rowsD = processedData.dispositivos.map(d => ({
      Tipo: d.tipo||'',
      Modelo: d.modelo||'',
      Serial: d.serial||'',
      MAC: (d.mac||'').toUpperCase(),
      Marca: d.marca||'',
      Zona: d.zona||'',
      Salud: d.estadoSalud||'S/C',
      Apariciones: d.apariciones.length
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rowsD), 'Dispositivos');

    if (useHealth && healthByZone.size){
      const summary = [];
      healthByZone.forEach((devices, zona) => {
        let up=0, down=0; devices.forEach(v => { if (v.estado===1) up++; else if (v.estado===0) down++; });
        const total = devices.size || (up+down);
        summary.push({ Zona: zona, TotalDispositivos: total, UP: up, DOWN: down, '% Salud': (total ? ((up/total)*100).toFixed(1)+'%' :
'0.0%' )
        });
      });
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summary), 'Resumen Salud');
    }

    XLSX.writeFile(wb, `Analisis_Global_${new Date().toISOString().slice(0,10)}.xlsx`);
  }
</script>
</body>
</html>

